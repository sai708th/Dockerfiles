version: '3'
dotenv: ['.env']  # ä»»æ„

vars:
  SERVICE: db
  DB: '{{.MYSQL_DATABASE | default "app"}}'
  ROOT_PW: '{{.MYSQL_ROOT_PASSWORD | default "root"}}'
  FILE: '{{.FILE | default "dump.sql"}}'
  TABLE: '{{.TABLE | default ""}}'
  WHERE: '{{.WHERE | default ""}}'
  SQL: '{{.SQL | default ""}}'
  OUT: '{{.OUT | default ""}}'

tasks:
  up:
    desc: "MySQL ã‚’èµ·å‹•"
    cmds:
      - docker compose up -d
      - task: wait

  down:
    desc: "MySQL ã‚’åœæ­¢ãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤"
    cmds:
      - docker compose down -v

  logs:
    desc: "ãƒ­ã‚°è¡¨ç¤º"
    cmds:
      - docker compose logs -f {{.SERVICE}}

  wait:
    internal: true
    silent: true
    cmds:
      - |
        set -e
        echo "â³ waiting for database (mysqladmin ping)..."
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ mysqladmin ping ã‚’å®Ÿè¡Œã—ã¦ç–Žé€šç¢ºèª
        for i in $(seq 1 60); do
          if docker compose exec -T {{.SERVICE}} sh -lc "mysqladmin ping -uroot -p{{.ROOT_PW}} --silent" >/dev/null 2>&1; then
            echo "âœ… database is ready"
            exit 0
          fi
          sleep 2
        done
        echo "âŒ DB not ready in time"; exit 1

  mysql:
    desc: "mysql ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæŽ¥ç¶šï¼ˆå¯¾è©±ï¼‰"
    cmds:
      - docker compose exec {{.SERVICE}} mysql -uroot -p{{.ROOT_PW}} {{.DB}}

  import:
    desc: "SQL ãƒ€ãƒ³ãƒ—ï¼ˆ.sql ã¾ãŸã¯ .sql.gzï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‚ä¾‹: task import FILE=data.sql.gz"
    cmds:
      - task: wait
      - |
        set -e
        if echo "{{.FILE}}" | grep -qiE '\.gz$'; then
          echo "ðŸ“¦ importing gzipped: {{.FILE}} -> {{.DB}}"
          gunzip -c "{{.FILE}}" | docker compose exec -T {{.SERVICE}} mysql -uroot -p{{.ROOT_PW}} {{.DB}}
        else
          echo "ðŸ“¦ importing: {{.FILE}} -> {{.DB}}"
          docker compose exec -T {{.SERVICE}} mysql -uroot -p{{.ROOT_PW}} {{.DB}} < "{{.FILE}}"
        fi
        echo "âœ… import done"

  exec:
    desc: "å˜ç™º SQL ã‚’å®Ÿè¡Œã€‚ä¾‹: task exec SQL='SHOW TABLES;'"
    cmds:
      - task: wait
      - |
        [ -z "{{.SQL}}" ] && echo "SQL ãŒç©ºã§ã™ï¼ˆSQL='...')" && exit 1
        docker compose exec -T {{.SERVICE}} mysql -uroot -p{{.ROOT_PW}} -e "{{.SQL}}" {{.DB}}

  dump-table:
    desc: "ä»»æ„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¡ä»¶ä»˜ãã§ãƒ€ãƒ³ãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã€‚ä¾‹: task dump-table TABLE=users WHERE=\"id IN (1,2)\" OUT=users.sql"
    cmds:
      - task: wait
      - |
        set -e
        [ -z "{{.TABLE}}" ] && echo "TABLE ãŒå¿…è¦ã§ã™ï¼ˆTABLE=...ï¼‰" && exit 1
        OUTFILE="{{.OUT}}"
        [ -z "$OUTFILE" ] && OUTFILE="{{.TABLE}}.sql"

        WHERE_OPT=""
        if [ -n "{{.WHERE}}" ]; then
          WHERE_OPT="--where={{.WHERE}}"
          echo "ðŸ§¾ dumping {{.TABLE}} with WHERE: {{.WHERE}}"
        else
          echo "ðŸ§¾ dumping {{.TABLE}} (all rows)"
        fi

        docker compose exec -T {{.SERVICE}} mysqldump -uroot -p{{.ROOT_PW}} \
          --single-transaction --skip-triggers --no-create-info --compact \
          --set-gtid-purged=OFF \
          {{.DB}} {{.TABLE}} $WHERE_OPT > "$OUTFILE"

        echo "âœ… output: $OUTFILE"

  dump-schema:
    desc: "ã‚¹ã‚­ãƒ¼ãƒžã®ã¿ãƒ€ãƒ³ãƒ—ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã€‚ä¾‹: task dump-schema OUT=schema.sql"
    cmds:
      - task: wait
      - |
        OUTFILE="{{.OUT}}"
        [ -z "$OUTFILE" ] && OUTFILE="schema.sql"
        docker compose exec -T {{.SERVICE}} mysqldump -uroot -p{{.ROOT_PW}} \
          --single-transaction --no-data --routines --events \
          --set-gtid-purged=OFF {{.DB}} > "$OUTFILE"
        echo "âœ… output: $OUTFILE"
